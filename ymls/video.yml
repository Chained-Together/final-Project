config:
  target: http://localhost:3000
  phases:
    - duration: 10
      arrivalRate: 1
  logLevel: 'debug'
  processor: './function.js'

scenarios:
  - name: signUpToSaveMetaData
    flow:
      # 1. 회원가입
      - post:
          url: /auth/signup
          json:
            email: 'user{{ $randomNumber(1, 10000) }}@test.com'
            password: 'test1234'
            confirmedPassword: 'test1234'
            name: 'test{{ $randomNumber(1, 10000) }}'
            nickname: 'nickname{{ $randomNumber(1, 10000) }}'
            code: '1' # 서버에서 허용하는 값으로 수정
            phoneNumber: '{{ $randomNumber(1000000000, 9999999999) }}'
          capture:
            - json: '$.email' # 응답에서 인증 코드를 추출
              as: email

      - think: 15

      # 3. 추가 요청 (로그인)
      - post:
          url: /auth/login
          json:
            email: '{{email}}'
            password: 'test1234'
          capture:
            - header: 'authorization'
              as: 'token'

      - think: 15

      - post:
          url: '/channel'
          followRedirect: false
          headers:
            Authorization: 'Bearer {{token}}'
          json:
            name: 'name{{ $randomNumber(1, 10000) }}'
            profileImage: 'test{{ $randomNumber(1, 10000) }}'

      - think: 15
      - post:
          url: '/s3/generate-url'
          headers:
            Authorization: 'Bearer {{token}}'
          json:
            fileType: 'video/mp4'
            fileSize: '{{ $randomNumber(1000000, 5000000) }}'
            bucket: '15-final-project'
            region: 'ap-northeast-2'
            fileName: 'file{{ $randomNumber(1, 1000000) }}.mp4'
          capture:
            - json: '$.presignedUrl'
              as: s3Url
            - json: '$.key'
              as: key
      - function: 'prepareFileContent'

      - think: 15
      - put:
          url: '{{s3Url}}' # S3 presigned URL
          headers:
            Content-Type: 'video/mp4'
          body: '{{fileContent}}'

      - think: 15
      - post:
          url: '/video'
          followRedirect: false
          headers:
            Authorization: 'Bearer {{token}}'
          json:
            title: 'title{{ $randomNumber(1, 10000) }}'
            description: 'description{{ $randomNumber(1, 10000) }}'
            thumbnailUrl: 'thumbnail{{ $randomNumber(1, 10000) }}'
            videoCode: '{{ key }}'
            hashtags: ['hashtag{{ $randomNumber(1, 10000) }}']
            visibility: 'public'

      - think: 15
      - get:
          url: /video/many/0/6

      - think: 15
      - get:
          url: /video/search/video{{ $randomNumber(1, 10000) }}
